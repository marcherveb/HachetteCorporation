--MD2

--grant all privileges to "Dragon_MD";

DROP MATERIALIZED VIEW ANALYSE_PREETABLIS_MD;
DROP MATERIALIZED VIEW TEMPS_MD;
DROP Dimension dim_temps_MD;
DROP MATERIALIZED VIEW GROUPEPRESSE_MD;
DROP Dimension dim_groupepresse_MD;
DROP MATERIALIZED VIEW TYPEJOURNALISTE_MD;
DROP Dimension dim_typejournaliste_MD;
--Alter table GROUPEPRESSE_MD DROP CONSTRAINT PK_GROUPEPRESSE ;   

-- rafraichir les materialized view
BEGIN DBMS_MVIEW.REFRESH( list => 'TEMPS_MD',Method =>'COMPLETE', refresh_after_errors => True);end;



-- dimension temps_MD --
CREATE MATERIALIZED VIEW TEMPS_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT DISTINCT to_char(N.DATENO,'DD-MM-YYYY') AS DATE_MD2, to_char(N.DATENO,'MM-YYYY') AS MOIS, to_char(N.DATENO,'YYYY') AS ANNEE,to_char(N.DATENO,'IW') AS SEMAINE
    FROM "DragonBI".NUMERO N;
    
ALTER TABLE TEMPS_MD ADD CONSTRAINT pk_temps_md PRIMARY KEY (DATE_MD2);

CREATE DIMENSION dim_temps_MD
    LEVEL niv_date IS (TEMPS_MD.DATE_MD2)
    LEVEL niv_mois IS (TEMPS_MD.MOIS)
	LEVEL niv_annee IS (TEMPS_MD.ANNEE)
    LEVEL niv_semaine IS (TEMPS_MD.SEMAINE)
HIERARCHY H_MOIS(
    niv_date CHILD OF niv_mois CHILD OF niv_annee)
HIERARCHY H_SEMAINE(
	niv_date CHILD OF niv_semaine CHILD OF niv_annee);
	
	
-- dimension groupepresse_MD
CREATE MATERIALIZED VIEW GROUPEPRESSE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT G.CODEGP, G.RAISONSOCIALEGP, G.TYPESOC
    FROM "DragonBI".GROUPEPRESSE G;

ALTER TABLE GROUPEPRESSE_MD ADD CONSTRAINT pk_groupepresse_md PRIMARY KEY (CODEGP);

CREATE DIMENSION dim_groupepresse_MD
    LEVEL niv_codeGP IS (groupepresse_MD.CODEGP)
    LEVEL niv_typesoc IS (groupepresse_MD.TYPESOC)
HIERARCHY H_GP(
    niv_codeGP CHILD OF niv_typesoc)
ATTRIBUTE niv_codeGP DETERMINES (groupepresse_MD.RAISONSOCIALEGP);



-- dimension TYPEJOURNALISTE_MD --
CREATE MATERIALIZED VIEW TYPEJOURNALISTE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT T.CODETYJ, T.NOMTYJ, T.PRIXCAR
	FROM "DragonBI".TYPEJOUR T;

ALTER TABLE TYPEJOURNALISTE_MD ADD CONSTRAINT pk_typejournaliste_md PRIMARY KEY (CODETYJ);

CREATE DIMENSION dim_typejournaliste_MD
	LEVEL niv_codetyj IS (TYPEJOURNALISTE_MD.CODETYJ)
--HIERARCHY H_TY (niv_codetyj)
ATTRIBUTE niv_codetyj DETERMINES (TYPEJOURNALISTE_MD.NOMTYJ)
ATTRIBUTE niv_codetyj DETERMINES (TYPEJOURNALISTE_MD.PRIXCAR);








-- FAIT ANALYSE_PREETABLIS_MD --
CREATE MATERIALIZED VIEW ANALYSE_PREETABLIS_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT to_char(N.DATENO,'DD-MM-YYYY') as DATE_MD2, J.CODETYJ, J.CODEGP, SUM(E.NBART) AS NBARTICLE_MD,
((select SUM(E1.NBART)
		FROM "DragonBI".ECRIREARTICLE E1, "DragonBI".NUMERO N1, "DragonBI".JOURNALISTE J1
		WHERE E1.CODEJ = J1.CODEJ
			AND J1.CODETYJ = J.CODETYJ
			AND to_char(N1.DATENO,'DD-MM-YYYY') = to_char(N.DATENO,'DD-MM-YYYY'))
/(select SUM(E2.NBART)
		FROM "DragonBI".ECRIREARTICLE E2, "DragonBI".NUMERO N2
		WHERE to_char(N2.DATENO,'DD-MM-YYYY') = to_char(N.DATENO,'DD-MM-YYYY'))) AS RENTABILITENBA_DATE_MD,
        
((select AVG(E3.NBART) AS NbArticleParJ_SEMAINE 
		FROM "DragonBI".ECRIREARTICLE E3, "DragonBI".NUMERO N3, "DragonBI".JOURNALISTE J2
		WHERE E3.CODEJ = J2.CODEJ
			AND J2.CODETYJ = J.CODETYJ
			AND to_char(N3.DATENO,'IW') = to_char(N.DATENO,'IW')) 
/(select SUM(E4.NBART) AS NbArticleTotal_SEMAINE
		FROM "DragonBI".ECRIREARTICLE E4, "DragonBI".NUMERO N4
		WHERE to_char(N4.DATENO,'IW') = to_char(N.DATENO,'IW'))) AS RENTABILITENBA_SEMAINE_MD,
        
((select sum(E5.NBART) AS NbArticleParJ_MOIS
		FROM "DragonBI".ECRIREARTICLE E5, "DragonBI".NUMERO N5, "DragonBI".JOURNALISTE J3
		WHERE E5.CODEJ = J3.CODEJ
			AND J3.CODETYJ = J.CODETYJ
			AND to_char(N5.DATENO,'MM-YYYY') = to_char(N.DATENO,'MM-YYYY'))
/(select SUM(E6.NBART) AS NbArticleTotal_MOIS
		FROM "DragonBI".ECRIREARTICLE E6, "DragonBI".NUMERO N6
		WHERE to_char(N6.DATENO,'MM-YYYY') = to_char(N.DATENO,'MM-YYYY'))) AS RENTABILITENBA_MOIS_MD,

((select sum(E7.NBART) AS NbArticleParJ_ANNEE
		FROM "DragonBI".ECRIREARTICLE E7, "DragonBI".NUMERO N7, "DragonBI".JOURNALISTE J4
		WHERE E7.CODEJ = J4.CODEJ
			AND J4.CODETYJ = J.CODETYJ
			AND to_char(N7.DATENO,'YYYY') = to_char(N.DATENO,'YYYY'))
/(select SUM(E8.NBART) AS NbArticleTotal_ANNEE
		FROM "DragonBI".ECRIREARTICLE E8, "DragonBI".NUMERO N8
		WHERE to_char(N8.DATENO,'YYYY') = to_char(N.DATENO,'YYYY'))) AS RENTABILITENBA_ANNEE_MD,

SUM(T.PRIXCAR * E.NBCAR + E.NBART * C.FORFAITART) AS VARIABLE_MD,

((Select SUM(T1.PRIXCAR * E9.NBCAR + E9.NBART * C1.FORFAITART)  AS salaireParType_DATE
		from "DragonBI".JOURNALISTE J5, "DragonBI".ECRIREARTICLE E9, "DragonBI".NUMERO N9, "DragonBI".COUTARTICLE C1, "DragonBI".TYPEJOUR T1
		where C1.CODEJ = J5.CODEJ
			and J5.CODEJ = E9.CODEJ
			and T1.CODETYJ = J5.CODETYJ
			and J.CODETYJ = T1.CODETYJ
			AND E9.CODENO = N9.CODENO
			AND to_char(N9.DATENO,'DD-MM-YYYY') = to_char(N.DATENO,'DD-MM-YYYY'))
/ (select SUM(T2.PRIXCAR * E10.NBCAR + E10.NBART * C2.FORFAITART) as VARIABLETotal_DATE
		from "DragonBI".JOURNALISTE J6, "DragonBI".ECRIREARTICLE E10, "DragonBI".NUMERO N10, "DragonBI".COUTARTICLE C2, "DragonBI".TYPEJOUR T2
		where C2.CODEJ = J6.CODEJ
			and J6.CODEJ = E10.CODEJ
			and T2.CODETYJ = J6.CODETYJ
			AND E10.CODENO = N10.CODENO
			AND to_char(N10.DATENO,'DD-MM-YYYY') = to_char(N.DATENO,'DD-MM-YYYY'))) AS VARIABLESTYJ_DATE_MD,

((Select AVG(T3.PRIXCAR * E11.NBCAR + E11.NBART * C3.FORFAITART) AS salaireParType_SEMAINE
		from "DragonBI".JOURNALISTE J7, "DragonBI".ECRIREARTICLE E11, "DragonBI".NUMERO N11, "DragonBI".COUTARTICLE C3, "DragonBI".TYPEJOUR T3
		where C3.CODEJ = J7.CODEJ
			and J7.CODEJ = E11.CODEJ
			and T3.CODETYJ = J7.CODETYJ
			and J.CODETYJ = T3.CODETYJ
			AND E11.CODENO = N11.CODENO
			AND to_char(N11.DATENO,'IW') = to_char(N.DATENO,'IW'))
/ (select SUM(T4.PRIXCAR * E12.NBCAR + E12.NBART * C4.FORFAITART) AS salaireTotal_SEMAINE
		from "DragonBI".JOURNALISTE J8, "DragonBI".ECRIREARTICLE E12, "DragonBI".NUMERO N12, "DragonBI".COUTARTICLE C4, "DragonBI".TYPEJOUR T4
		where C4.CODEJ = J8.CODEJ
			and J8.CODEJ = E12.CODEJ
			and T4.CODETYJ = J8.CODETYJ
			AND E12.CODENO = N12.CODENO
			AND to_char(N12.DATENO,'IW') = to_char(N.DATENO,'IW'))) AS VARIABLESTYJ_SEMAINE_MD,
			
((Select AVG(T5.PRIXCAR * E13.NBCAR + E13.NBART * C5.FORFAITART) AS salaireParType_MOIS
		from "DragonBI".JOURNALISTE J9, "DragonBI".ECRIREARTICLE E13, "DragonBI".NUMERO N13, "DragonBI".COUTARTICLE C5, "DragonBI".TYPEJOUR T5
		where C5.CODEJ = J9.CODEJ
			and J9.CODEJ = E13.CODEJ
			and T5.CODETYJ = J9.CODETYJ
			and J.CODETYJ = T5.CODETYJ
			AND E13.CODENO = N13.CODENO
			AND to_char(N13.DATENO,'MM-YYYY') = to_char(N.DATENO,'MM-YYYY'))
/ (select SUM(T6.PRIXCAR * E14.NBCAR + E14.NBART * C6.FORFAITART) AS salaireTotal_MOIS
		from "DragonBI".JOURNALISTE J10, "DragonBI".ECRIREARTICLE E14, "DragonBI".NUMERO N14, "DragonBI".COUTARTICLE C6, "DragonBI".TYPEJOUR T6
		where C6.CODEJ = J10.CODEJ
			and J10.CODEJ = E14.CODEJ
			and T6.CODETYJ = J10.CODETYJ
			AND E14.CODENO = N14.CODENO
			AND to_char(N14.DATENO,'MM-YYYY') = to_char(N.DATENO,'MM-YYYY'))) AS VARIABLESTYJ_MOIS_MD,

((Select AVG(T7.PRIXCAR * E15.NBCAR + E15.NBART * C7.FORFAITART) AS salaireParType_ANNEE
		from "DragonBI".JOURNALISTE J11, "DragonBI".ECRIREARTICLE E15, "DragonBI".NUMERO N15, "DragonBI".COUTARTICLE C7, "DragonBI".TYPEJOUR T7
		where C7.CODEJ = J11.CODEJ
			and J11.CODEJ = E15.CODEJ
			and T7.CODETYJ = J11.CODETYJ
			and J.CODETYJ = T7.CODETYJ
			AND E15.CODENO = N15.CODENO
			AND to_char(N15.DATENO,'YYYY') = to_char(N.DATENO,'YYYY'))
/ (select SUM(T8.PRIXCAR * E16.NBCAR + E16.NBART * C8.FORFAITART) AS salaireTotal_ANNEE
		from "DragonBI".JOURNALISTE J12, "DragonBI".ECRIREARTICLE E16, "DragonBI".NUMERO N16, "DragonBI".COUTARTICLE C8, "DragonBI".TYPEJOUR T8
		where C8.CODEJ = J12.CODEJ
			and J12.CODEJ = E16.CODEJ
			and T8.CODETYJ = J12.CODETYJ
			AND E16.CODENO = N16.CODENO
			AND to_char(N16.DATENO,'YYYY') = to_char(N.DATENO,'YYYY'))) AS VARIABLESTYJ_ANNEE_MD,

((Select SUM(T9.PRIXCAR * E17.NBCAR + E17.NBART * C9.FORFAITART) AS salaireParG_DATE
		from "DragonBI".JOURNALISTE J13, "DragonBI".ECRIREARTICLE E17, "DragonBI".NUMERO N17, "DragonBI".COUTARTICLE C9, "DragonBI".TYPEJOUR T9
		where C9.CODEJ = J13.CODEJ
			and J13.CODEJ = E17.CODEJ
			and T9.CODETYJ = J13.CODETYJ
			AND E17.CODENO = N17.CODENO
			AND J13.CODEGP = J.CODEGP
			AND to_char(N17.DATENO,'DD-MM-YYYY') = to_char(N.DATENO,'DD-MM-YYYY'))
/ (select SUM(T10.PRIXCAR * E18.NBCAR + E18.NBART * C10.FORFAITART) as salaireTotal_DATE
		from "DragonBI".JOURNALISTE J14, "DragonBI".ECRIREARTICLE E18, "DragonBI".NUMERO N18, "DragonBI".COUTARTICLE C10, "DragonBI".TYPEJOUR T10
		where C10.CODEJ = J14.CODEJ
			and J14.CODEJ = E18.CODEJ
			and T10.CODETYJ = J14.CODETYJ
			AND E18.CODENO = N18.CODENO
			AND to_char(N18.DATENO,'DD-MM-YYYY') = to_char(N.DATENO,'DD-MM-YYYY'))) AS VARIABLESG_DATE_MD,

((Select AVG(T11.PRIXCAR * E19.NBCAR + E19.NBART * C11.FORFAITART) AS salaireParG_SEMAINE
		from "DragonBI".JOURNALISTE J15, "DragonBI".ECRIREARTICLE E19, "DragonBI".NUMERO N19, "DragonBI".COUTARTICLE C11, "DragonBI".TYPEJOUR T11
		where C11.CODEJ = J15.CODEJ
			and J15.CODEJ = E19.CODEJ
			and T11.CODETYJ = J15.CODETYJ
			AND E19.CODENO = N19.CODENO
			AND J15.CODEGP = J.CODEGP
			AND to_char(N19.DATENO,'IW') = to_char(N.DATENO,'IW'))
/ (select SUM(T12.PRIXCAR * E20.NBCAR + E20.NBART * C12.FORFAITART) AS salaireTotal_SEMAINE
		from "DragonBI".JOURNALISTE J16, "DragonBI".ECRIREARTICLE E20, "DragonBI".NUMERO N20, "DragonBI".COUTARTICLE C12, "DragonBI".TYPEJOUR T12
		where C12.CODEJ = J16.CODEJ
			and J16.CODEJ = E20.CODEJ
			and T12.CODETYJ = J16.CODETYJ
			AND E20.CODENO = N20.CODENO
			AND to_char(N20.DATENO,'IW') = to_char(N.DATENO,'IW'))) AS VARIABLESG_SEMAINE_MD,

((Select AVG(T13.PRIXCAR * E21.NBCAR + E21.NBART * C13.FORFAITART) AS salaireParG_MOIS
		from "DragonBI".JOURNALISTE J17, "DragonBI".ECRIREARTICLE E21, "DragonBI".NUMERO N21, "DragonBI".COUTARTICLE C13, "DragonBI".TYPEJOUR T13
		where C13.CODEJ = J17.CODEJ
			and J17.CODEJ = E21.CODEJ
			and T13.CODETYJ = J17.CODETYJ
			AND E21.CODENO = N21.CODENO
			AND J17.CODEGP = J.CODEGP
			AND to_char(N21.DATENO,'MM-YYYY') = to_char(N.DATENO,'MM-YYYY'))
/ (select SUM(T14.PRIXCAR * E22.NBCAR + E22.NBART * C14.FORFAITART) AS salaireTotal_MOIS
		from "DragonBI".JOURNALISTE J18, "DragonBI".ECRIREARTICLE E22, "DragonBI".NUMERO N22, "DragonBI".COUTARTICLE C14, "DragonBI".TYPEJOUR T14
		where C14.CODEJ = J18.CODEJ
			and J18.CODEJ = E22.CODEJ
			and T14.CODETYJ = J18.CODETYJ
			AND E22.CODENO = N22.CODENO
			AND to_char(N22.DATENO,'MM-YYYY') = to_char(N.DATENO,'MM-YYYY'))) AS VARIABLESG_MOIS_MD,

((Select AVG(T15.PRIXCAR * E23.NBCAR + E23.NBART * C15.FORFAITART) AS salaireParG_ANNEE
		from "DragonBI".JOURNALISTE J19, "DragonBI".ECRIREARTICLE E23, "DragonBI".NUMERO N23, "DragonBI".COUTARTICLE C15, "DragonBI".TYPEJOUR T15
		where C15.CODEJ = J19.CODEJ
			and J19.CODEJ = E23.CODEJ
			and T15.CODETYJ = J19.CODETYJ
			AND E23.CODENO = N23.CODENO
			AND J19.CODEGP = J.CODEGP
			AND to_char(N23.DATENO,'YYYY') = to_char(N.DATENO,'YYYY'))
/ (select SUM(T16.PRIXCAR * E24.NBCAR + E24.NBART * C16.FORFAITART) AS salaireTotal_ANNEE
		from "DragonBI".JOURNALISTE J20, "DragonBI".ECRIREARTICLE E24, "DragonBI".NUMERO N24, "DragonBI".COUTARTICLE C16, "DragonBI".TYPEJOUR T16
		where C16.CODEJ = J20.CODEJ
			and J20.CODEJ = E24.CODEJ
			and T16.CODETYJ = J20.CODETYJ
			AND E24.CODENO = N24.CODENO
			AND to_char(N24.DATENO,'YYYY') = to_char(N.DATENO,'YYYY')
        GROUP BY to_char(N24.DATENO,'YYYY'))) AS VARIABLESG_ANNEE_MD        
        
	FROM "DragonBI".JOURNALISTE J, "DragonBI".ECRIREARTICLE E, "DragonBI".NUMERO N, "DragonBI".COUTARTICLE C, "DragonBI".TYPEJOUR T
	WHERE J.CODETYJ = T.CODETYJ
        AND J.CODEJ = E.CODEJ
		AND E.CODENO = N.CODENO
		AND C.CODEJ = J.CODEJ
	GROUP BY to_char(N.DATENO,'DD-MM-YYYY'), J.CODETYJ, J.CODEGP, to_char(N.DATENO,'IW'),  to_char(N.DATENO,'MM-YYYY'),  to_char(N.DATENO,'YYYY');

ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT pk_ANALYSE_PREETABLIS_MD PRIMARY KEY (DATE_MD2, CODETYJ, CODEGP);

ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT fk_ANALYSE_PREETABLIS_temps FOREIGN KEY (DATE_MD2) REFERENCES TEMPS_MD (DATE_MD2);
ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT fk_ANALYSE_PREETABLIS_TYPEJ FOREIGN KEY (CODETYJ) REFERENCES TYPEJOURNALISTE_MD (CODETYJ);
ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT fk_ANALYSE_PREETABLIS_GROUP FOREIGN KEY (CODEGP) REFERENCES GROUPEPRESSE_MD (CODEGP);


ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT NN_ANALYSE_PREETABLIS_TEMPS CHECK (DATE_MD2 IS NOT NULL);
ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT NN_ANALYSE_PREETABLIS_TYPEJ CHECK (CODETYJ IS NOT NULL);
ALTER TABLE ANALYSE_PREETABLIS_MD ADD CONSTRAINT NN_ANALYSE_PREETABLIS_GROUP CHECK (CODEGP IS NOT NULL);







--MD2
-- AGG_PRO_VARIABLE_NBA_ANNEE_TYJ


CREATE MATERIALIZED VIEW AGG_PRO_VARIABLE_NBA_ANNEE_TYJ
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT TY.CODETYJ, TY.NOMTYJ, T.ANNEE, SUM(A.VARIABLESTYJ_ANNEE_MD) AS PRO_VARIABLETYJ_ANNEE, SUM(A.NBARTICLE_MD) AS NBARTICLE_ANNEE, SUM(VARIABLE_MD) AS VARIABLETYJ_ANNEE
	FROM TYPEJOURNALISTE_MD TY, TEMPS_MD T, ANALYSE_PREETABLIS_MD A
	WHERE TY.CODETYJ = A.CODETYJ
		AND A.DATE_MD2 = T.DATE_MD2
	GROUP BY TY.CODETYJ, TY.NOMTYJ, T.ANNEE;


-- AGG_NBA_TYJ


CREATE MATERIALIZED VIEW AGG_NBA_TYJ
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT CODETYJ, NOMTYJ, SUM(NBARTICLE_ANNEE) AS NBARTICLE_TYJ
	FROM AGG_PRO_VARIABLE_NBA_ANNEE_TYJ
	GROUP BY CODETYJ, NOMTYJ;
	


--AGG_VARIABLE_MOIS_GP


CREATE MATERIALIZED VIEW AGG_VARIABLE_MOIS_GP
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT G.CODEGP, G.RAISONSOCIALEGP, T.MOIS, SUM(A.VARIABLE_MD) AS VARIABLEGP_MOIS
	FROM TEMPS_MD T, ANALYSE_PREETABLIS_MD A, GROUPEPRESSE_MD G
	WHERE T.DATE_MD2 = A.DATE_MD2
		AND G.CODEGP = A.CODEGP
	GROUP BY G.CODEGP, G.RAISONSOCIALEGP, T.MOIS;
























