--MD4
DROP MATERIALIZED VIEW MARKETING_MD;



-- DIMENSION VERSIONWEB_MD

CREATE MATERIALIZED VIEW VERSIONWEB_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT V.CODEVW, V.URL
	FROM "DragonBI".VERSIONWEB V;

ALTER TABLE VERSIONWEB_MD ADD CONSTRAINT pk_versionweb_md PRIMARY KEY (CODEVW);

CREATE DIMENSION dim_versionweb_md
	LEVEL niv_codevw IS (VERSIONWEB_MD.CODEVW)

ATTRIBUTE niv_codevw DETERMINES (VERSIONWEB_MD.URL);
	




-- DIMENSION PUBLICATION_MD
CREATE MATERIALIZED VIEW PUBLICATION_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT P.CODEPU, P.NOMPU, P.PERIODICITE, TP.CODETY, TP.NOMTY, G.CODEGP, G.RAISONSOCIALEGP , G.TYPESOC
	FROM "DragonBI".PUBLICATION P, "DragonBI".TYPEPU TP, "DragonBI".GROUPEPRESSE G
	WHERE P.CODETY = TP.CODETY
		AND G.CODEGP = P.CODEGP;

ALTER TABLE PUBLICATION_MD ADD CONSTRAINT pk_publication_md PRIMARY KEY (CODEPU);

CREATE DIMENSION dim_publication_MD
	LEVEL niv_codep IS (PUBLICATION_MD.CODEPU)
	LEVEL niv_periodicite IS (PUBLICATION_MD.PERIODICITE)
	LEVEL niv_codety IS (PUBLICATION_MD.CODETY)
	LEVEL niv_codegp IS (PUBLICATION_MD.CODEGP)
	LEVEL niv_typesoc	IS (PUBLICATION_MD.TYPESOC)
	
HIERARCHY H_PERIODICITE (niv_codep CHILD OF niv_periodicite)
HIERARCHY H_TYPEP (niv_codep CHILD OF niv_codety)
HIERARCHY H_GP (niv_codep CHILD OF niv_codegp CHILD OF niv_typesoc)

ATTRIBUTE niv_codep DETERMINES (PUBLICATION_MD.NOMPU)
ATTRIBUTE niv_codety DETERMINES (PUBLICATION_MD.NOMTY)
ATTRIBUTE niv_codegp DETERMINES (PUBLICATION_MD.RAISONSOCIALEGP);




-- dimension temps_MD --

CREATE MATERIALIZED VIEW TEMPS_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT DISTINCT to_char(P.DATEVENTE,'MM-YYYY') AS MOIS, to_char(P.DATEVENTE,'YYYY') AS ANNEE
    FROM "DragonBI".PAYER P;
    
ALTER TABLE TEMPS_MD ADD CONSTRAINT pk_temps_md PRIMARY KEY (MOIS);

CREATE DIMENSION dim_temps_MD
    LEVEL niv_mois IS (TEMPS_MD.MOIS)
	LEVEL niv_annee IS (TEMPS_MD.ANNEE)
HIERARCHY H_MOIS(
    niv_mois CHILD OF niv_annee);


-- dimension VILLE_MD --

CREATE MATERIALIZED VIEW VILLE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT V.CODEV, V.NOMV, C.CODECD, C.NOMCD, C.VILLECD, P.CODEP, P.NOMP
	FROM "DragonBI".CENTREDISTRIBUTEUR C, "DragonBI".PAYS P, "DragonBI".VILLE V
	WHERE C.CODEP = P.CODEP
		AND C.CODECD = V.CODECD;

ALTER TABLE VILLE_MD ADD CONSTRAINT pk_ville_md PRIMARY KEY (CODEV);

CREATE DIMENSION dim_ville_MD
    LEVEL niv_codev IS (VILLE_MD.CODEV)
	LEVEL niv_codecd IS (VILLE_MD.CODECD)
	LEVEL niv_codep IS (VILLE_MD.CODEP)
HIERARCHY H_V(
	niv_codev CHILD OF niv_codecd CHILD OF niv_codep)
ATTRIBUTE niv_codev DETERMINES (VILLE_MD.NOMV)
ATTRIBUTE niv_codecd DETERMINES (VILLE_MD.NOMCD)
ATTRIBUTE niv_codecd DETERMINES (VILLE_MD.VILLECD)
ATTRIBUTE niv_codep DETERMINES (VILLE_MD.NOMP);


-- fait MARKETING_MD

CREATE MATERIALIZED VIEW MARKETING_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT to_char(PA.DATEVENTE,'MM-YYYY') AS MOIS, PU.CODEVW, P.CODEPU, V.CODEV, SUM(E.NBART) AS NBARTICLE_MD, SUM(PA.PRIXNUMPUBLIC * PA.NBVENTE) AS CAVENTES_MD , SUM(A.PRIXNUMAB * A.NBNUM) AS CAABONNER_MD, SUM(PA.PRIXNUMPUBLIC * PA.NBVENTE + A.PRIXNUMAB * A.NBNUM) AS CATOTAL_MD, SUM(PU.NBVISITE) AS NBVISITEUR, SUM(PA.NBVENTE) AS NBVENTE_MD, SUM(A.NBNUM) AS NBABONNER_MD
	
	FROM "DragonBI".PUBLICATION P, "DragonBI".PUBLIER PU, "DragonBI".NUMERO N, "DragonBI".ECRIREARTICLE E, "DragonBI".PAYER PA, "DragonBI".ABONNER A, "DragonBI".PAYS PAY, "DragonBI".CENTREDISTRIBUTEUR C, "DragonBI".VILLE V, "DragonBI".CLIENT CL
	WHERE P.CODEPU = PU.CODEPU
		AND P.CODEPU = A.CODEPU
		AND P.CODEPU = PA.CODEPU
		AND N.CODEPU = P.CODEPU
		AND N.CODENO = E.CODENO
		AND PA.CODEP = PAY.CODEP
		AND C.CODEP = PAY.CODEP
		AND C.CODECD = V.CODECD
		AND V.CODEV = CL.CODEV
		AND CL.CODEC = A.CODEC
	GROUP BY to_char(PA.DATEVENTE,'MM-YYYY'), PU.CODEVW, P.CODEPU, V.CODEV, PAY.CODEP;

ALTER TABLE MARKETING_MD ADD CONSTRAINT pk_marketing_md PRIMARY KEY(MOIS, CODEVW, CODEPU , CODEV);

ALTER TABLE MARKETING_MD ADD CONSTRAINT fk_MARKETING_temps FOREIGN KEY (MOIS) REFERENCES TEMPS_MD (MOIS);
ALTER TABLE MARKETING_MD ADD CONSTRAINT fk_MARKETING_VERSIONWEB FOREIGN KEY (CODEVW) REFERENCES VERSIONWEB_MD (CODEVW);
ALTER TABLE MARKETING_MD ADD CONSTRAINT fk_MARKETING_PUBLICATION FOREIGN KEY (CODEPU) REFERENCES PUBLICATION_MD (CODEPU);
ALTER TABLE MARKETING_MD ADD CONSTRAINT fk_MARKETING_VILLE FOREIGN KEY (CODEV) REFERENCES VILLE_MD (CODEV);


ALTER TABLE MARKETING_MD ADD CONSTRAINT NN_MARKETING_temps CHECK (MOIS IS NOT NULL);
ALTER TABLE MARKETING_MD ADD CONSTRAINT NN_MARKETING_VERSIONWEB CHECK (CODEVW IS NOT NULL);
ALTER TABLE MARKETING_MD ADD CONSTRAINT NN_MARKETING_PUBLICATION CHECK (CODEPU IS NOT NULL);
ALTER TABLE MARKETING_MD ADD CONSTRAINT NN_MARKETING_VILLE CHECK (CODEV IS NOT NULL);














