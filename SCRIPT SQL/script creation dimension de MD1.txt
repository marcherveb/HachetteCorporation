--grant all privileges to "Dragon_MD";

DROP MATERIALIZED VIEW ANALYSE1_JOURNALISTE_MD;
DROP MATERIALIZED VIEW ANALYSE2_JOURNALISTE_MD;
DROP MATERIALIZED VIEW TEMPS1_MD;
DROP Dimension dim_temps1_MD;
DROP MATERIALIZED VIEW TEMPS2_MD;
DROP Dimension dim_temps2_MD;
DROP MATERIALIZED VIEW JOURNALISTE_MD;
DROP Dimension dim_journaliste_MD;
DROP MATERIALIZED VIEW PUBLICATION_MD;
DROP Dimension dim_publication_MD;
--Alter table GROUPEPRESSE_MD DROP CONSTRAINT PK_GROUPEPRESSE ;   
--(question : pourquoi il y a un clé premier déjà existe dans la table dimension quand on excute la permier partie de tous les codes "sql"?)







-- dimension temps1_MD --

CREATE MATERIALIZED VIEW TEMPS1_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT DISTINCT to_char(N.DATENO,'DD-MM-YYYY') AS DATE1_md1, to_char(N.DATENO,'MM-YYYY') AS MOIS1, to_char(N.DATENO,'YYYY') AS ANNEE1, to_char(N.DATENO,'IW') AS SEMAINE1
    FROM "DragonBI".NUMERO N
    ;
    
ALTER TABLE TEMPS1_MD ADD CONSTRAINT pk_temps1_md PRIMARY KEY (DATE1_md1);

CREATE DIMENSION dim_temps1_MD
    LEVEL niv_date IS (TEMPS1_MD.DATE1_md1)
    LEVEL niv_mois IS (TEMPS1_MD.MOIS1)
	LEVEL niv_annee IS (TEMPS1_MD.ANNEE1)
    LEVEL niv_semaine IS (TEMPS1_MD.SEMAINE1)
HIERARCHY H_MOIS1(
    niv_date CHILD OF niv_mois CHILD OF niv_annee)
HIERARCHY H_SEMAINE1(
	niv_date CHILD OF niv_semaine CHILD OF niv_annee);
	



-- dimension temps2_MD --

CREATE MATERIALIZED VIEW TEMPS2_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT DISTINCT to_char(N.DATENO,'MM-YYYY') AS MOIS2, to_char(N.DATENO,'YYYY') AS ANNEE2
    FROM "DragonBI".NUMERO N;
    
ALTER TABLE TEMPS2_MD ADD CONSTRAINT pk_temps2_md PRIMARY KEY (MOIS2);

CREATE DIMENSION dim_temps2_MD
    LEVEL niv_mois2 IS (TEMPS2_MD.MOIS2)
	LEVEL niv_annee2 IS (TEMPS2_MD.ANNEE2)
HIERARCHY H_MOIS2(
    niv_mois2 CHILD OF niv_annee2);


	
-- dimension JOURNALISTE_MD --
CREATE MATERIALIZED VIEW JOURNALISTE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT J.CODEJ, J.NOMJ, J.PRENOMJ, J.SEXEJ, J.RUEJ, J.VILLE, J.CPJ, J.TELJ, J.FIXEJ, J.NB_HEURESFORMATION, J.TYPE_CONTRAT, J.NOTESATISFATION_RECRUTEMENT, D.CODEDI, D.NOMDI, I.CODEIF, I.NOMIF, T.CODETYJ, T.NOMTYJ, T.PRIXCAR, G.CODEGP AS CODEGP_J, G.RAISONSOCIALEGP AS RAISONSOCIALEGP_J, G.TYPESOC AS TYPESOC_J
	FROM "DragonBI".JOURNALISTE J, "DragonBI".TYPEJOUR T, "DragonBI".DIPLOME D, "DragonBI".INSTITUTFORMATION I, "DragonBI".GROUPEPRESSE G
	WHERE J.CODEDI = D.CODEDI
		AND D.CODEIF = I.CODEIF
		AND J.CODEGP = G.CODEGP
		AND J.CODETYJ = T.CODETYJ;

ALTER TABLE JOURNALISTE_MD ADD CONSTRAINT pk_journaliste_md PRIMARY KEY (CODEJ);

CREATE DIMENSION dim_journaliste_MD
	LEVEL niv_codej IS (JOURNALISTE_MD.CODEJ)
	LEVEL niv_codetyj IS (JOURNALISTE_MD.CODETYJ)
	LEVEL niv_codegp_j IS (JOURNALISTE_MD.CODEGP_J)
	LEVEL niv_typesoc_j IS (JOURNALISTE_MD.TYPESOC_J)
	LEVEL niv_codedi IS (JOURNALISTE_MD.CODEDI)	
	LEVEL niv_codeif IS (JOURNALISTE_MD.CODEIF)
HIERARCHY H_DI(
	niv_codej CHILD OF niv_codedi CHILD OF niv_codeif)
HIERARCHY H_GPJ(
	niv_codej CHILD OF niv_codegp_j CHILD OF niv_typesoc_j)
HIERARCHY H_TYJ(
	niv_codej CHILD OF niv_codetyj)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.NOMJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.PRENOMJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.SEXEJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.RUEJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.CPJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.TELJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.FIXEJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.NB_HEURESFORMATION)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.TYPE_CONTRAT)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.NOTESATISFATION_RECRUTEMENT)
ATTRIBUTE niv_codedi DETERMINES (JOURNALISTE_MD.NOMDI)
ATTRIBUTE niv_codeif DETERMINES (JOURNALISTE_MD.NOMIF)
ATTRIBUTE niv_codetyj DETERMINES (JOURNALISTE_MD.PRIXCAR)
ATTRIBUTE niv_codetyj DETERMINES (JOURNALISTE_MD.NOMTYJ)
ATTRIBUTE niv_codegp_j DETERMINES (JOURNALISTE_MD.RAISONSOCIALEGP_J);





-- DIMENSION PUBLICATION_MD
CREATE MATERIALIZED VIEW PUBLICATION_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT P.CODEPU, P.NOMPU, P.PERIODICITE, TP.CODETY, TP.NOMTY, G1.CODEGP AS CODEGP_P, G1.RAISONSOCIALEGP AS RAISONSOCIALEGP_P, G1.TYPESOC AS TYPESOC_P, J.CODEJ AS CODEJ_P, J.NOMJ AS NOMJ_P, J.PRENOMJ AS PRENOMJ_P, J.SEXEJ AS SEXEJ_P, J.RUEJ AS RUEJ_P, J.CPJ AS CPJ_P, J.TELJ AS TELJ_P, J.FIXEJ AS FIXEJ_P, J.NB_HEURESFORMATION_P, J.TYPE_CONTRAT_P, J.NOTESATISFATION_RECRUTEMENT_P, D.CODEDI AS CODEDI_P, D.NOMDI AS NOMDI_P, I.CODEIF AS CODEIF_P, I.NOMIF AS NOMIF_P, T.CODETYJ AS CODETYJ_P , T.NOMTYJ AS NOMTYJ_P, T.PRIXCAR AS PRIXCAR_P, G2.CODEGP AS CODEGP_PJ, G2.RAISONSOCIALEGP AS RAISONSOCIALEGP_PJ, G2.TYPESOC AS TYPESOC_PJ
	FROM "DragonBI".PUBLICATION P, "DragonBI".TYPEPU TP, "DragonBI".GROUPEPRESSE G1, "DragonBI".GROUPEPRESSE G2, "DragonBI".JOURNALISTE J, "DragonBI".TYPEJOUR T, "DragonBI".DIPLOME D, "DragonBI".INSTITUTFORMATION I
	WHERE P.CODETY = TP.CODETY
		AND G1.CODEGP = P.CODEGP
		AND P.CODEJ = J.CODEJ
		AND J.CODEDI = D.CODEDI
		AND D.CODEIF = I.CODEIF
		AND J.CODETYJ = T.CODETYJ
		AND J.CODEGP = G2.CODEGP;

ALTER TABLE PUBLICATION_MD ADD CONSTRAINT pk_publication_md PRIMARY KEY (CODEPU);

CREATE DIMENSION dim_publication_MD
	LEVEL niv_codep IS (PUBLICATION_MD.CODEPU)
	LEVEL niv_periodicite IS (PUBLICATION_MD.PERIODICITE)
	LEVEL niv_codety IS (PUBLICATION_MD.CODETY)
	LEVEL niv_codegp_p IS (PUBLICATION_MD.CODEGP_P)
	LEVEL niv_typesoc_p	IS (PUBLICATION_MD.TYPESOC_P)
	LEVEL niv_codej_p IS (PUBLICATION_MD.CODEJ_P)
	LEVEL niv_codetyj_p IS (PUBLICATION_MD.CODETYJ_P)
	LEVEL niv_codegp_pj IS (PUBLICATION_MD.CODEGP_PJ)
	LEVEL niv_typesoc_pj IS (PUBLICATION_MD.TYPESOC_PJ)
	LEVEL niv_codedi_p IS (PUBLICATION_MD.CODEDI_P)	
	LEVEL niv_codeif_p IS (PUBLICATION_MD.CODEIF_P)
HIERARCHY H_PERIODICITE (niv_codep CHILD OF niv_periodicite)
HIERARCHY H_TYPEP (niv_codep CHILD OF niv_codety)
HIERARCHY H_GP_P (niv_codep CHILD OF niv_codegp_p CHILD OF niv_typesoc_p)
HIERARCHY H_DI (niv_codep CHILD OF niv_codej_p CHILD OF niv_codedi_p CHILD OF niv_codeif_p)
HIERARCHY H_TYJ (niv_codep CHILD OF niv_codej_p CHILD OF niv_codetyj_p)
HIERARCHY H_GP_PJ (niv_codep CHILD OF niv_codej_p CHILD OF niv_codegp_pj CHILD OF niv_typesoc_pj)
ATTRIBUTE niv_codep DETERMINES (PUBLICATION_MD.NOMPU)
ATTRIBUTE niv_codety DETERMINES (PUBLICATION_MD.NOMTY)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.NOMJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.PRENOMJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.SEXEJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.RUEJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.CPJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.TELJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.FIXEJ_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.NB_HEURESFORMATION_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.TYPE_CONTRAT_P)
ATTRIBUTE niv_codej_p DETERMINES (PUBLICATION_MD.NOTESATISFATION_RECRUTEMENT_P)
ATTRIBUTE niv_codedi_p DETERMINES (PUBLICATION_MD.NOMDI_P)
ATTRIBUTE niv_codeif_p DETERMINES (PUBLICATION_MD.NOMIF_P)
ATTRIBUTE niv_codetyj_p DETERMINES (PUBLICATION_MD.PRIXCAR_P)
ATTRIBUTE niv_codetyj_p DETERMINES (PUBLICATION_MD.NOMTYJ_P)
ATTRIBUTE niv_codegp_pj DETERMINES (PUBLICATION_MD.RAISONSOCIALEGP_PJ)
ATTRIBUTE niv_codegp_p DETERMINES (PUBLICATION_MD.RAISONSOCIALEGP_P);




-- FAIT ANALYSE1_JOURNALISTE_MD --
CREATE MATERIALIZED VIEW ANALYSE1_JOURNALISTE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT to_char(N.DATENO,'DD-MM-YYYY') AS DATE1_md1, J.CODEJ, P.CODEPU, SUM(E.NBART) AS NBARTICLE_MD, SUM(T.PRIXCAR * E.NBCAR + E.NBART * C.FORFAITART) AS MONGTANTVARIABLE_MD
	FROM "DragonBI".JOURNALISTE J, "DragonBI".NUMERO N, "DragonBI".ECRIREARTICLE E, "DragonBI".PUBLICATION P, "DragonBI".TYPEJOUR T, "DragonBI".COUTARTICLE C
	WHERE J.CODEJ = E.CODEJ
		AND E.CODENO = N.CODENO
		AND P.CODEPU = N.CODEPU
		AND J.CODETYJ = T.CODETYJ
		AND J.CODEJ = E.CODEJ
		AND J.CODEJ = C.CODEJ
	GROUP BY to_char(N.DATENO,'DD-MM-YYYY'), J.CODEJ, P.CODEPU;
	
ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT pk_analyse_journaliste_md PRIMARY KEY (CODEJ, DATE1_md1, CODEPU);

ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT fk_analyse_journaliste_TEMPS1 FOREIGN KEY (DATE1_md1) REFERENCES TEMPS1_MD (DATE1_md1);
ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT fk_analyse_journaliste_JOURN FOREIGN KEY (CODEJ) REFERENCES JOURNALISTE_MD (CODEJ);
ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT fk_analyse_journaliste_PUBLI FOREIGN KEY (CODEPU) REFERENCES PUBLICATION_MD (CODEPU);

ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT NN_analyse_journaliste_TEMPS1 CHECK (DATE1_md1 IS NOT NULL);
ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT NN_analyse_journaliste_JOURN CHECK (CODEJ IS NOT NULL);
ALTER TABLE ANALYSE1_JOURNALISTE_MD ADD CONSTRAINT NN_analyse_journaliste_PUBLI CHECK (CODEPU IS NOT NULL);



-- FAIT ANALYSE2_JOURNALISTE_MD --
CREATE MATERIALIZED VIEW ANALYSE2_JOURNALISTE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT to_char(N.DATENO,'MM-YYYY') AS MOIS2_md1, J.CODEJ, P.CODEPU, (SUM(T.PRIXCAR * E.NBCAR + E.NBART * C.FORFAITART) + avg(J.FIXEJ)) AS MONTANTSALAIRE_MD
	FROM "DragonBI".JOURNALISTE J, "DragonBI".NUMERO N, "DragonBI".ECRIREARTICLE E, "DragonBI".PUBLICATION P, "DragonBI".TYPEJOUR T, "DragonBI".COUTARTICLE C
	WHERE J.CODEJ = E.CODEJ
		AND E.CODENO = N.CODENO
		AND P.CODEPU = N.CODEPU
		AND J.CODETYJ = T.CODETYJ
		AND J.CODEJ = E.CODEJ
		AND J.CODEJ = C.CODEJ
	GROUP BY to_char(N.DATENO,'MM-YYYY'), J.CODEJ, P.CODEPU;

ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT pk_analyse2_journaliste_md PRIMARY KEY (CODEJ, MOIS2_md1, CODEPU);

ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT fk_analyse2_journaliste_TEMPS2 FOREIGN KEY (MOIS2_md1) REFERENCES TEMPS2_MD (MOIS2);
ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT fk_analyse2_journaliste_JOURN FOREIGN KEY (CODEJ) REFERENCES JOURNALISTE_MD (CODEJ);
ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT fk_analyse2_journaliste_PUBLI FOREIGN KEY (CODEPU) REFERENCES PUBLICATION_MD (CODEPU);

ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT NN_analyse2_journaliste_TEMPS2 CHECK (MOIS2_md1 IS NOT NULL);
ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT NN_analyse2_journaliste_JOURN CHECK (CODEJ IS NOT NULL);
ALTER TABLE ANALYSE2_JOURNALISTE_MD ADD CONSTRAINT NN_analyse2_journaliste_PUBLI CHECK (CODEPU IS NOT NULL);





















