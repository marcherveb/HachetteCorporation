--MD3
DROP MATERIALIZED VIEW ANALYSE_PREDEFINIS_MD;
DROP VIEW ANALYSE;
DROP MATERIALIZED VIEW JOURNALISTE_MD;
DROP Dimension dim_journaliste_MD;
DROP MATERIALIZED VIEW TEMPS_MD;
DROP Dimension dim_temps_MD;


--grant all privileges to "Dragon_MD";

--DROP MATERIALIZED VIEW GROUPEPRESSE_MD;
--DROP Dimension dim_groupepresse_MD;
--Alter table GROUPEPRESSE_MD DROP CONSTRAINT PK_GROUPEPRESSE ;   


-- dimension JOURNALISTE_MD --
CREATE MATERIALIZED VIEW JOURNALISTE_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT J.CODEJ, J.NOMJ, J.PRENOMJ, J.SEXEJ, J.RUEJ, J.CPJ, J.TELJ, J.FIXEJ, D.CODEDI, D.NOMDI, I.CODEIF, I.NOMIF, T.CODETYJ, T.NOMTYJ, T.PRIXCAR, G.CODEGP, G.RAISONSOCIALEGP, G.TYPESOC, J.DATEEMBAUCHE, J.DATEOBT, J.NB_HEURESFORMATION, J.TYPE_CONTRAT, J.NOTESATISFATION_RECRUTEMENT
	FROM "DragonBI".JOURNALISTE J, "DragonBI".TYPEJOUR T, "DragonBI".DIPLOME D, "DragonBI".INSTITUTFORMATION I, "DragonBI".GROUPEPRESSE G
	WHERE J.CODEDI = D.CODEDI
		AND D.CODEIF = I.CODEIF
		AND J.CODEGP = G.CODEGP
		AND J.CODETYJ = T.CODETYJ;

ALTER TABLE JOURNALISTE_MD ADD CONSTRAINT pk_journaliste_md PRIMARY KEY (CODEJ);

CREATE DIMENSION dim_journaliste_MD
	LEVEL niv_codej IS (JOURNALISTE_MD.CODEJ)
	LEVEL niv_codetyj IS (JOURNALISTE_MD.CODETYJ)
	LEVEL niv_codegp IS (JOURNALISTE_MD.CODEGP)
	LEVEL niv_typesoc IS (JOURNALISTE_MD.TYPESOC)
	LEVEL niv_codedi IS (JOURNALISTE_MD.CODEDI)	
	LEVEL niv_codeif IS (JOURNALISTE_MD.CODEIF)
HIERARCHY H_DI(
	niv_codej CHILD OF niv_codedi CHILD OF niv_codeif)
HIERARCHY H_GPJ(
	niv_codej CHILD OF niv_codegp CHILD OF niv_typesoc)
HIERARCHY H_TYJ(
	niv_codej CHILD OF niv_codetyj)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.NOMJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.PRENOMJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.SEXEJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.RUEJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.CPJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.TELJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.FIXEJ)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.DATEEMBAUCHE)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.DATEOBT)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.NB_HEURESFORMATION)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.TYPE_CONTRAT)
ATTRIBUTE niv_codej DETERMINES (JOURNALISTE_MD.NOTESATISFATION_RECRUTEMENT)
ATTRIBUTE niv_codedi DETERMINES (JOURNALISTE_MD.NOMDI)
ATTRIBUTE niv_codeif DETERMINES (JOURNALISTE_MD.NOMIF)
ATTRIBUTE niv_codetyj DETERMINES (JOURNALISTE_MD.PRIXCAR)
ATTRIBUTE niv_codetyj DETERMINES (JOURNALISTE_MD.NOMTYJ)
ATTRIBUTE niv_codegp DETERMINES (JOURNALISTE_MD.RAISONSOCIALEGP);




-- dimension temps_MD --
CREATE MATERIALIZED VIEW TEMPS_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT DISTINCT to_char(N.DATENO,'DD-MM-YYYY') AS DATE_MD3, to_char(N.DATENO,'MM-YYYY') AS MOIS, to_char(N.DATENO,'YYYY') AS ANNEE,to_char(N.DATENO,'IW') AS SEMAINE
    FROM "DragonBI".NUMERO N;
    
ALTER TABLE TEMPS_MD ADD CONSTRAINT pk_temps_md PRIMARY KEY (DATE_MD3);

CREATE DIMENSION dim_temps_MD
    LEVEL niv_date IS (TEMPS_MD.DATE_MD3)
    LEVEL niv_mois IS (TEMPS_MD.MOIS)
	LEVEL niv_annee IS (TEMPS_MD.ANNEE)
    LEVEL niv_semaine IS (TEMPS_MD.SEMAINE)
HIERARCHY H_MOIS(
    niv_date CHILD OF niv_mois CHILD OF niv_annee)
HIERARCHY H_SEMAINE(
	niv_date CHILD OF niv_semaine CHILD OF niv_annee);



-- FAIT ANALYSE_PREDEFINIS_MD --

CREATE VIEW ANALYSE
AS SELECT to_char(N.DATENO,'DD-MM-YYYY') AS DATE_MD3, J.CODEJ, J.CODETYJ, SUM(J.DATEEMBAUCHE - J.DATEOBT) AS DELAI_MD, SUM(E.NBART) AS NBARTICLE_MD, SUM(E.NBCAR) AS NBCAR_MD,
(SELECT COUNT(R2.ESTRETARD)
    FROM "DragonBI".RENDRE R2
    WHERE R2.CODEJ = J.CODEJ
        AND R2.ESTRETARD = 'R'
    ) AS NB_FOIS_RETARD_MD, 
(SELECT COUNT(R3.ESTRETARD)
    FROM "DragonBI".RENDRE R3
    WHERE R3.CODEJ = J.CODEJ
        AND R3.ESTRETARD = 'A'
    ) AS NB_FOIS_AVANT_MD, 
(SELECT AVG(R4.DATERENDU - R4.DATERENDUEXIGE)
    FROM "DragonBI".RENDRE R4
    WHERE R4.CODEJ = J.CODEJ
        AND R4.ESTRETARD = 'R') AS MOY_DELAI_RETARD_MD
    
	FROM "DragonBI".JOURNALISTE J, "DragonBI".ECRIREARTICLE E, "DragonBI".NUMERO N
	WHERE J.CODEJ = E.CODEJ
        AND N.CODENO = E.CODENO
	GROUP BY J.CODEJ, to_char(N.DATENO,'DD-MM-YYYY'), J.CODETYJ;
    
    
    
CREATE MATERIALIZED VIEW ANALYSE_PREDEFINIS_MD
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT DATE_MD3, CODEJ, DELAI_MD, NBARTICLE_MD, NBCAR_MD,  NB_FOIS_AVANT_MD, NB_FOIS_RETARD_MD, MOY_DELAI_RETARD_MD
    FROM ANALYSE
    GROUP BY DATE_MD3, CODEJ, DELAI_MD, NBARTICLE_MD, NBCAR_MD,  NB_FOIS_AVANT_MD, NB_FOIS_RETARD_MD, MOY_DELAI_RETARD_MD;

ALTER TABLE ANALYSE_PREDEFINIS_MD ADD CONSTRAINT pk_analyse_predefinis_md PRIMARY KEY (DATE_MD3, CODEJ);

ALTER TABLE ANALYSE_PREDEFINIS_MD ADD CONSTRAINT fk_analyse_predefinis_TEMPS FOREIGN KEY (DATE_MD3) REFERENCES TEMPS_MD (DATE_MD3);
ALTER TABLE ANALYSE_PREDEFINIS_MD ADD CONSTRAINT fk_analyse_predefinis_JOURN FOREIGN KEY (CODEJ) REFERENCES JOURNALISTE_MD (CODEJ);







--MD3
--AGG_DELAIS_ANNEE_TYJ
DROP MATERIALIZED VIEW AGG_DELAIS_ANNEE_TYJ;
CREATE MATERIALIZED VIEW AGG_DELAIS_ANNEE_TYJ
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT T.ANNEE, J.CODETYJ, J.NOMTYJ, J.NOMIF, J.DATEOBT, AVG(A.DELAI_MD) AS MOY_DELAI
	FROM TEMPS_MD T, JOURNALISTE_MD J, ANALYSE_PREDEFINIS_MD A
	WHERE A.DATE_MD3 = T.DATE_MD3
		AND A.CODEJ = J.CODEJ
    GROUP BY T.ANNEE, J.CODETYJ, J.NOMTYJ, J.NOMIF, J.DATEOBT
;


-- AGG_NBA_NBC_J_DATE
DROP MATERIALIZED VIEW AGG_NBA_NBC_J_DATE;
CREATE MATERIALIZED VIEW AGG_NBA_NBC_J_DATE
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS SELECT T.DATE_MD3, J.CODEJ, J.NOMJ, SUM(NBARTICLE_MD) AS NBARTICLE_DATE, SUM(NBCAR_MD) AS NBCARA_DATE
	FROM TEMPS_MD T, JOURNALISTE_MD J, ANALYSE_PREDEFINIS_MD A
	WHERE A.DATE_MD3 = T.DATE_MD3
		AND A.CODEJ = J.CODEJ
	GROUP BY T.DATE_MD3, J.CODEJ, J.NOMJ;























